#!/bin/bash

name="$1"
host="$2"
port="$3"
form="$4"

if [ "$form" = "" ]; then
    echo "Usage: $0 <NAME> <HOST> <PORT> <FORM>"
    echo "Example: $0 lights stories 8409 \"(+ 3 4)\""
    exit
fi

# Create a random IV that's 16 bytes long.
iv=$(printf %16.16s $(echo $RANDOM | md5sum | cut -d' ' -f1))

# Get the secret from the ~/.authinfo file for this service and
# front-pad it.
secret=$(printf %32s $(grep "machine $name " ~/.authinfo | sed 's/^.*password //'))

# Encrypt the form we're sending over.
message=$(echo "$form" |\
	      openssl enc -aes-256-cbc -nosalt\
		      -K $(echo -n "$secret" | xxd -c 256 -pu)\
		      -iv $(echo -n "$iv" | xxd -c 256 -pu) | base64)

length=${#form}
ivbase=$(echo -n $iv | base64)

response=$(echo "(:iv \"$ivbase\" :length $length :message \"$message\")" |\
    nc "$host" "$port")

riv=$(echo $response | awk '{ print $2; }' | sed 's/"//g')
rlength=$(echo $response | awk '{ print $4; }')
rmessage=$(echo $response | awk '{ print $6; }' | sed 's/["\)]//g')

echo -n "$rmessage" | base64 -d |\
    openssl enc -d -aes-256-cbc -nosalt\
	    -K $(echo -n "$secret" | xxd -c 256 -pu)\
	    -iv $(echo -n "$riv" | base64 -d | xxd -c 256 -pu)
